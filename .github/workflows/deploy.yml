name: CI/CD with Jest & Vercel

on:
  pull_request:
    branches:
      - dev
  push:
    branches:
      - dev

jobs:
  test_and_build:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Node.js ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: "npm"

      # 3ï¸âƒ£ íŒ¨í‚¤ì§€ ì„¤ì¹˜
      - name: Install dependencies
        run: npm install

      # 4ï¸âƒ£ Jest í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (PR ì‹œ ìˆ˜í–‰)
      - name: Run Jest Tests
        if: github.event_name == 'pull_request'
        run: npm test

      # 5ï¸âƒ£ ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (PR & Merge ì‹œ ìˆ˜í–‰)
      - name: Build Test
        run: npm run build

      # 6ï¸âƒ£ Jest ì„±ê³µ ì‹œ Discord ì•Œë¦¼ (PR ì‹œì—ë§Œ ì‹¤í–‰)
      - name: Notify Discord on Jest Success
        if: success() && github.event_name == 'pull_request'
        run: |
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_TITLE="${{ github.event.pull_request.title }}"

          JSON_PAYLOAD=$(jq -n \
            --arg username "Deploy Bot" \
            --arg title "âœ… JEST í…ŒìŠ¤íŠ¸ ì„±ê³µ! ğŸ‰" \
            --arg desc1 "Next.js í”„ë¡œì íŠ¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼ë˜ì—ˆìŠµë‹ˆë‹¤." \
            --arg desc2 "$PR_TITLE" \
            --arg desc3 "($PR_URL)" \
            --arg color "65280" \
            '{
              username: $username,
              embeds: [{
                title: $title,
                color: ($color | tonumber),
                fields: [
                  { "name": "ğŸš€ ë¹Œë“œ ìƒíƒœ", "value": $desc1, "inline": false },
                  { "name": "ğŸ“Œ PR ì œëª©", "value": $desc2, "inline": false },
                  { "name": "ğŸ”— PR ë§í¬", "value": $desc3, "inline": false }
                ]
              }]
            }')

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$JSON_PAYLOAD" \
               "${{ secrets.DISCORD_WEBHOOK_URL }}"

      # 7ï¸âƒ£ ë¹Œë“œ ì„±ê³µ ì‹œ Discord ì•Œë¦¼ (PR & Merge ì‹œ)
      - name: Notify Discord on Build Success
        if: success()
        run: |
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_TITLE="${{ github.event.pull_request.title }}"

          JSON_PAYLOAD=$(jq -n \
            --arg username "Deploy Bot" \
            --arg title "âœ… ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì„±ê³µ! ğŸ‰" \
            --arg desc1 "Next.js í”„ë¡œì íŠ¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼ë˜ì—ˆìŠµë‹ˆë‹¤." \
            --arg desc2 "$PR_TITLE" \
            --arg desc3 "($PR_URL)" \
            --arg color "65280" \
            '{
              username: $username,
              embeds: [{
                title: $title,
                color: ($color | tonumber),
                fields: [
                  { "name": "ğŸš€ ë¹Œë“œ ìƒíƒœ", "value": $desc1, "inline": false },
                  { "name": "ğŸ“Œ PR ì œëª©", "value": $desc2, "inline": false },
                  { "name": "ğŸ”— PR ë§í¬", "value": $desc3, "inline": false }
                ]
              }]
            }')

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$JSON_PAYLOAD" \
               "${{ secrets.DISCORD_WEBHOOK_URL }}"

      # 8ï¸âƒ£ Jest ì‹¤íŒ¨ ì‹œ Discord ì•Œë¦¼ (PR ì‹œì—ë§Œ ì‹¤í–‰)
      - name: Notify Discord on Jest Failure
        if: failure() && github.event_name == 'pull_request'
        run: |
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_TITLE="${{ github.event.pull_request.title }}"

          JSON_PAYLOAD=$(jq -n \
            --arg username "Deploy Bot" \
            --arg title "âŒ Jest í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨! ğŸš¨" \
            --arg desc1 "í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ë¡œ ì¸í•´ ë³‘í•©ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤." \
            --arg desc2 "$PR_TITLE" \
            --arg desc3 "($PR_URL)" \
            --arg color "15158332" \
            '{
              username: $username,
              embeds: [{
                title: $title,
                color: ($color | tonumber),
                fields: [
                  { "name": "ğŸš¨ ì˜¤ë¥˜ ìƒíƒœ", "value": $desc1, "inline": false },
                  { "name": "ğŸ“Œ PR ì œëª©", "value": $desc2, "inline": false },
                  { "name": "ğŸ”— PR ë§í¬", "value": $desc3, "inline": false },
                ]
              }]
            }')

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$JSON_PAYLOAD" \
               "${{ secrets.DISCORD_WEBHOOK_URL }}"

      # 9ï¸âƒ£ ë¹Œë“œ ì‹¤íŒ¨ ì‹œ Discord ì•Œë¦¼ (PR & Merge ì‹œ)
      - name: Notify Discord on Build Failure
        if: failure()
        run: |
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_TITLE="${{ github.event.pull_request.title }}"

          JSON_PAYLOAD=$(jq -n \
            --arg username "Deploy Bot" \
            --arg title "âŒ ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨! ğŸš¨" \
            --arg desc1 "ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ë¡œ ì¸í•´ ë°°í¬ê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤." \
            --arg desc2 "$PR_TITLE" \
            --arg desc3 "($PR_URL)" \
            --arg color "15158332" \
            '{
              username: $username,
              embeds: [{
                title: $title,
                color: ($color | tonumber),
                fields: [
                  { "name": "ğŸš¨ ì˜¤ë¥˜ ìƒíƒœ", "value": $desc1, "inline": false },
                  { "name": "ğŸ“Œ PR ì œëª©", "value": $desc2, "inline": false },
                  { "name": "ğŸ”— PR ë§í¬", "value": $desc3, "inline": false },
                ]
              }]
            }')

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$JSON_PAYLOAD" \
               "${{ secrets.DISCORD_WEBHOOK_URL }}"
        continue-on-error: false

  fork_and_deploy:
    needs: test_and_build
    if: success() && github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ GitHub APIë¥¼ ì‚¬ìš©í•˜ì—¬ Fork ìƒì„±
      - name: Fork repository using GitHub API
        run: |
          curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/sweav-org/sweav_client_web/forks

      # 2ï¸âƒ£ Forkê°€ ìƒì„±ë  ë•Œê¹Œì§€ ëŒ€ê¸° (GitHub ë°˜ì˜ ì‹œê°„ í•„ìš”)
      - name: Wait for Fork to be available
        run: sleep 10 # 10ì´ˆ ëŒ€ê¸°

      # 3ï¸âƒ£ Forkëœ ë ˆí¬ì§€í† ë¦¬ Clone
      - name: Checkout Forked Repository
        uses: actions/checkout@v3
        with:
          repository: "ysk9926/sweav_client_web"
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      # 4ï¸âƒ£ Node.js ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: "npm"

      # 5ï¸âƒ£ íŒ¨í‚¤ì§€ ì„¤ì¹˜
      - name: Install dependencies
        run: npm install

      # 6ï¸âƒ£ Vercel ë°°í¬
      - name: Deploy to Vercel
        run: npx vercel --prod --yes --token ${{ secrets.VERCEL_TOKEN }}

      # 7ï¸âƒ£ Vercel ë°°í¬ ì„±ê³µ ì‹œ Discord ì•Œë¦¼ (Merge ê³¼ì •)
      - name: Notify Discord on Vercel Success
        if: success()
        run: |
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          DEPLOY_URL="https://sweav-client-web.vercel.app"

          JSON_PAYLOAD=$(jq -n \
            --arg username "Deploy Bot" \
            --arg title "ğŸš€ Vercel ë°°í¬ ì„±ê³µ! ğŸ‰" \
            --arg desc1 "Forkëœ ë ˆí¬ì§€í† ë¦¬ì—ì„œ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!" \
            --arg desc2 "($DEPLOY_URL)" \
            --arg desc3 "$COMMIT_MESSAGE" \
            --arg color "65280" \
            '{
              username: $username,
              embeds: [{
                title: $title,
                color: ($color | tonumber),
                fields: [
                  { "name": "âœ… ë°°í¬ ìƒíƒœ", "value": $desc1, "inline": false },
                  { "name": "ğŸ”— ë°°í¬ ë§í¬", "value": $desc2, "inline": false },
                  { "name": "ğŸ’¬ Merge Commit ë©”ì‹œì§€", "value": $desc3, "inline": false }
                ]
              }]
            }')

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$JSON_PAYLOAD" \
               "${{ secrets.DISCORD_WEBHOOK_URL }}"

      # 8ï¸âƒ£ Vercel ë°°í¬ ì‹¤íŒ¨ ì‹œ Discord ì•Œë¦¼ (Merge ê³¼ì •)
      - name: Notify Discord on Vercel Failure
        if: failure()
        run: |
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          DEPLOY_URL="https://sweav-client-web.vercel.app"

          JSON_PAYLOAD=$(jq -n \
            --arg username "Deploy Bot" \
            --arg title "ğŸ”¥ Vercel ë°°í¬ ì‹¤íŒ¨! ğŸš¨" \
            --arg desc1 "Forkëœ ë ˆí¬ì§€í† ë¦¬ì—ì„œ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤." \
            --arg desc2 "$COMMIT_MESSAGE" \
            --arg color "65280" \
            '{
              username: $username,
              embeds: [{
                title: $title,
                color: ($color | tonumber),
                fields: [
                  { "name": "ğŸš¨ ë°°í¬ ìƒíƒœ", "value": $desc1, "inline": false },
                  { "name": "ğŸ’¬ Merge Commit ë©”ì‹œì§€", "value": $desc2, "inline": false }
                ]
              }]
            }')

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$JSON_PAYLOAD" \
               "${{ secrets.DISCORD_WEBHOOK_URL }}"
               
          echo "âŒ Vercel ë°°í¬ ì‹¤íŒ¨! GitHub Actionsë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤."
          exit 1  # â— GitHub Actionsë¥¼ ê°•ì œ ì‹¤íŒ¨ ì²˜ë¦¬ (Merge ì°¨ë‹¨)
